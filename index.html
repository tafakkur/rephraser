<!doctype html>
<html>
	<head>
		<title>Text Moderator</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<body>
		<div class="container">
			<h1>Text Moderator</h1>
			<p class="header-desc">
				AI-powered assistant to sanitize text and remove offensive language.
			</p>

			<div class="grid">
				<div class="main-content">
					<div id="systemStatus" class="status">Connecting to system...</div>

					<form id="moderateForm">
						<label style="font-weight: 600; display: block; margin-bottom: 10px"
							>Enter Message to Moderate:</label
						>
						<textarea
							id="inputText"
							rows="8"
							placeholder="Type or paste customer message here..."
						></textarea>

						<div class="file-upload-area">
							<label for="fileInput" class="file-label">
								üìÅ Or upload a .txt file
							</label>
							<input
								type="file"
								id="fileInput"
								accept=".txt"
								style="display: none"
							/>
							<span id="fileName" class="file-name"></span>
						</div>

						<button type="submit" id="submitBtn">
							<span class="loading-spinner" id="spinner"></span>
							Moderate Text
						</button>
					</form>

					<div id="resultArea"></div>
				</div>

				<div class="sidebar">
					<div class="control-panel">
						<h3>Banned Terms</h3>
						<p style="font-size: 13px; color: #666; margin-bottom: 10px">
							<span id="termsCount">Loading...</span>
							<a href="#" id="viewTermsLink" style="margin-left: 8px"
								>View/Edit</a
							>
						</p>
						<div class="file-upload-area">
							<label for="termsFileInput" class="file-label">
								üìÑ Upload custom terms (.txt)
							</label>
							<input
								type="file"
								id="termsFileInput"
								accept=".txt"
								style="display: none"
							/>
							<span id="termsFileName" class="file-name"></span>
							<div style="font-size: 11px; color: #999; margin-top: 5px">
								One term per line
							</div>
						</div>
					</div>

					<div class="samples-area">
						<h3>Sample Inputs</h3>
						<div id="sampleButtons"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Banned Terms Modal -->
		<div id="termsModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h3>Banned Terms</h3>
					<span class="modal-close">&times;</span>
				</div>
				<div class="modal-body">
					<p style="font-size: 13px; color: #666; margin-bottom: 10px">
						One term per line. Changes are applied immediately.
					</p>
					<textarea
						id="termsEditor"
						rows="15"
						placeholder="Enter banned terms, one per line..."
					></textarea>
				</div>
				<div class="modal-footer">
					<button id="saveTermsBtn" class="btn-primary">Save Changes</button>
					<button id="cancelTermsBtn" class="btn-secondary">Cancel</button>
				</div>
			</div>
		</div>

		<!-- Download Modal -->
		<div id="downloadModal" class="modal download-modal">
			<div class="modal-content" style="max-width: 400px; text-align: center">
				<div class="modal-body" style="padding: 40px 30px">
					<div class="download-spinner"></div>
					<h3 style="margin: 20px 0 10px">LLM Model Downloading</h3>
					<p
						id="downloadStatus"
						style="color: #666; font-size: 14px; line-height: 1.6"
					>
						Please wait while the AI model downloads.<br />
						This may take a few minutes on first run.
					</p>
					<div class="progress-container">
						<div class="progress-bar" id="downloadProgress"></div>
					</div>
					<p
						id="downloadPercent"
						style="color: #2196f3; font-weight: 600; margin-top: 10px"
					>
						0%
					</p>
				</div>
			</div>
		</div>

		<script>
			// Clear text box on page load
			document.getElementById("inputText").value = "";

			// Load samples
			fetch("/samples")
				.then((r) => r.json())
				.then((samples) => {
					const container = document.getElementById("sampleButtons");
					samples.forEach((text) => {
						const btn = document.createElement("button");
						btn.className = "sample-btn";
						btn.textContent =
							text.length > 50 ? text.substring(0, 47) + "..." : text;
						btn.onclick = () =>
							(document.getElementById("inputText").value = text);
						container.appendChild(btn);
					});
				});

			// File upload handler for input text
			document.getElementById("fileInput").addEventListener("change", (e) => {
				const file = e.target.files[0];
				if (file) {
					document.getElementById("fileName").textContent = file.name;
					const reader = new FileReader();
					reader.onload = (event) => {
						document.getElementById("inputText").value = event.target.result;
					};
					reader.readAsText(file);
				}
			});

			// Banned terms file upload handler
			document
				.getElementById("termsFileInput")
				.addEventListener("change", async (e) => {
					const file = e.target.files[0];
					if (file) {
						document.getElementById("termsFileName").textContent =
							"Uploading...";
						const reader = new FileReader();
						reader.onload = async (event) => {
							try {
								const res = await fetch("/banned-terms", {
									method: "POST",
									headers: { "Content-Type": "text/plain" },
									body: event.target.result,
								});
								const data = await res.json();
								if (data.success) {
									document.getElementById("termsFileName").textContent =
										`‚úì ${file.name}`;
									document.getElementById("termsCount").textContent =
										`${data.count} terms loaded`;
								} else {
									document.getElementById("termsFileName").textContent =
										"Error uploading";
								}
							} catch (err) {
								document.getElementById("termsFileName").textContent =
									"Upload failed";
							}
						};
						reader.readAsText(file);
					}
				});

			// Load initial terms count
			fetch("/banned-terms")
				.then((r) => r.json())
				.then((data) => {
					document.getElementById("termsCount").textContent =
						`${data.count} terms loaded`;
				});

			// Modal functionality
			const modal = document.getElementById("termsModal");
			const viewLink = document.getElementById("viewTermsLink");
			const closeBtn = document.querySelector(".modal-close");
			const saveBtn = document.getElementById("saveTermsBtn");
			const cancelBtn = document.getElementById("cancelTermsBtn");
			const termsEditor = document.getElementById("termsEditor");

			viewLink.onclick = async (e) => {
				e.preventDefault();
				const res = await fetch("/banned-terms");
				const data = await res.json();
				termsEditor.value = data.terms.join("\n");
				modal.style.display = "flex";
			};

			closeBtn.onclick = () => (modal.style.display = "none");
			cancelBtn.onclick = () => (modal.style.display = "none");
			modal.onclick = (e) => {
				if (e.target === modal) modal.style.display = "none";
			};

			saveBtn.onclick = async () => {
				saveBtn.textContent = "Saving...";
				saveBtn.disabled = true;
				try {
					const res = await fetch("/banned-terms", {
						method: "POST",
						headers: { "Content-Type": "text/plain" },
						body: termsEditor.value,
					});
					const data = await res.json();
					if (data.success) {
						document.getElementById("termsCount").textContent =
							`${data.count} terms loaded`;
						modal.style.display = "none";
					}
				} catch (err) {
					alert("Failed to save terms");
				}
				saveBtn.textContent = "Save Changes";
				saveBtn.disabled = false;
			};

			// Check status
			let modelDownloading = false;
			async function checkStatus() {
				try {
					const res = await fetch("/status");
					const data = await res.json();
					const div = document.getElementById("systemStatus");
					const downloadModal = document.getElementById("downloadModal");

					if (data.llm_ready) {
						div.className = "status success";
						div.innerHTML = "‚úÖ System Online | AI Model Ready";
						if (downloadModal) downloadModal.style.display = "none";
						modelDownloading = false;
					} else if (data.llm_downloading) {
						div.className = "status";
						div.innerHTML = "‚è≥ LLM Model Downloading...";
						if (downloadModal && !modelDownloading) {
							downloadModal.style.display = "flex";
							modelDownloading = true;
							startModelDownload();
						}
					} else {
						div.className = "status error";
						div.innerHTML = "‚ö†Ô∏è AI Service Offline";
						if (downloadModal) downloadModal.style.display = "none";
					}
				} catch (e) {
					console.error(e);
				}
			}
			checkStatus();
			setInterval(checkStatus, 5000);

			// Start model download with progress
			function startModelDownload() {
				const eventSource = new EventSource("/pull-model");
				const progressBar = document.getElementById("downloadProgress");
				const percentText = document.getElementById("downloadPercent");
				const statusText = document.getElementById("downloadStatus");

				eventSource.onmessage = (event) => {
					try {
						const data = JSON.parse(event.data);
						if (data.progress > 0) {
							progressBar.style.width = data.progress + "%";
							percentText.textContent = data.progress + "%";
						}
						if (data.status) {
							statusText.textContent = data.status;
						}
						if (data.done) {
							eventSource.close();
							if (data.progress === 100) {
								checkStatus();
							}
						}
					} catch (e) {
						console.error("Parse error:", e);
					}
				};

				eventSource.onerror = () => {
					eventSource.close();
				};
			}

			document.getElementById("moderateForm").onsubmit = async (e) => {
				e.preventDefault();
				const text = document.getElementById("inputText").value;

				if (!text.trim()) return alert("Please enter some text");

				const btn = document.getElementById("submitBtn");
				const spinner = document.getElementById("spinner");
				const resultArea = document.getElementById("resultArea");

				btn.disabled = true;
				spinner.style.display = "inline-block";
				resultArea.innerHTML = "";

				try {
					const res = await fetch("/moderate", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ text }),
					});

					const data = await res.json();

					let resultHtml = "";

					if (data.changes && data.changes.length > 0) {
						resultHtml = `
							<div class="result-box visible">
								<h2 style="color: #2e7d32; margin-top: 0;">Moderation Complete</h2>
								<p style="color: #666;">Found ${data.changes.length} sentence(s) with offensive content. Each has been rewritten by AI.</p>
								<table class="results-table">
									<thead>
										<tr>
											<th>Sn</th>
											<th>Line #</th>
											<th>Original Text</th>
											<th>Revised Text</th>
										</tr>
									</thead>
									<tbody>
										${data.changes
											.map(
												(c, i) => `
											<tr>
												<td>${i + 1}</td>
												<td>${c.lineNumber}</td>
												<td>${c.originalHighlighted}</td>
												<td>${c.revised}</td>
											</tr>
										`,
											)
											.join("")}
									</tbody>
								</table>
							</div>
						`;
					} else {
						resultHtml = `
							<div class="result-box visible">
								<h2 style="color: #2e7d32; margin-top: 0;">‚úÖ No Issues Found</h2>
								<p style="color: #666;">No offensive terms were detected in the text.</p>
							</div>
						`;
					}

					resultArea.innerHTML = resultHtml;
				} catch (err) {
					resultArea.innerHTML =
						'<div class="status error">Error processing request</div>';
					console.error(err);
				} finally {
					btn.disabled = false;
					spinner.style.display = "none";
				}
			};
		</script>
	</body>
</html>
